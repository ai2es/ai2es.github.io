<!DOCTYPE html>
<html lang="en">
<head>
<title>ML Storm Viewer</title>
</head>
<script src="https://d3js.org/d3-fetch.v3.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.5.1.min.js"></script>
<script>
let grid_file = "https://gridrad-storm.s3.us-west-2.amazonaws.com/storm_poly_YYYYMMDD.geojson";
async function update() {
    let sel_date = document.getElementById("date_sel").value;
    let grid_file_date = grid_file.replace("YYYYMMDD", sel_date);
    let data = await d3.json(grid_file_date);

    let data_table = {};
    data_table["polygon_lat"] = [];
    data_table["polygon_lon"] = [];
    data_table["lon"] = [];
    data_table["lat"] = [];
    data_table["valid_time_unix_sec"] = [];
    data_table["valid_time_date"] = [];
    for (let i = 0; i < data.features.length; i++) {
        data_table["polygon_lat"][i] = []
        data_table["polygon_lon"][i] = []
        for (let j = 0; j < data.features[i].geometry.coordinates[0].length; j++) {
            data_table["polygon_lat"][i].push(data.features[i].geometry.coordinates[0][j][1]);
            data_table["polygon_lon"][i].push(data.features[i].geometry.coordinates[0][j][0]);
        }
        data_table["valid_time_unix_sec"][i] = (data.features[i].properties.valid_time_unix_sec);
        data_table["valid_time_date"][i] = new Date(0);
        data_table["valid_time_date"][i].setUTCSeconds(data_table["valid_time_unix_sec"][i]);
    }
    let plot_data = [];
    for (let i = 0; i < data.features.length; i++) {
        plot_data[i] = [{type: "scattermapbox", fill: "toself", lon: data_table["polygon_lon"][i], lat: data_table["polygon_lat"][i]}];
    }

    let layout = {mapbox: {center: {lon: -90, lat: 30}, zoom: 4, style: "open-street-map"}, width: 1000, height: 800}
    Plotly.newPlot(document.getElementById("test"), plot_data[0], layout);
    // for (let i = 1; i < data.features.length; i++) {
    //     Plotly.react(document.getElementById("test"), plot_data[i], layout);
    // }
}
</script>

<body onload="update()">
<label for="date_sel">Date: </label><select id="date_sel" name="date_sel" onchange="update()">
<option value="20110427">2011-04-27</option>
<option value="20130516">2013-05-16</option>
<option value="20130519">2013-05-19</option>
<option value="20130520">2013-05-20</option>
<option value="20130520">2013-05-20</option>
</select>
<div id="test">
</div>

</body>
</html>
